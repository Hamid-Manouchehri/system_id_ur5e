%{
*******************************************************************************
Project: system-id ur5e
File: id_validation.py
Author: Hamid Manouchehri
Email: hmanouch@buffalo.edu
Date: May 26, 2025

Description:
Validation of calculated analytical model (inverse dynamics(ID)); reading 
logged trajectory and substituting in the derived model (.mat file).

License:
This script is licensed under the MIT License.
You may obtain a copy of the License at
    https://opensource.org/licenses/MIT

SPDX-License-Identifier: MIT

Disclaimer:
This software is provided "as is", without warranty of any kind, express or
implied, including but not limited to the warranties of merchantability,
fitness for a particular purpose, and noninfringement. In no event shall the
authors be liable for any claim, damages, or other liability, whether in an
action of contract, tort, or otherwise, arising from, out of, or in connection
with the software or the use or other dealings in the software.

*******************************************************************************
%}
clc; clear; close all;

syms g q1 q2 q3 q4 q5 q6 dq1 dq2 dq3 dq4 dq5 dq6 ddq1 ddq2 ddq3 ddq4 ddq5 ddq6 ... % Joint State
    m1 m2 m3 m4 m5 m6 ... % mi = m_li + m_m_i+1
    I_h1xx I_h1xy I_h1xz I_h1yy I_h1yz I_h1zz ... % Steiner Theorem : I_hixx = I_li + m_li*S(r_Ci,li)'*S(r_Ci,li) + m_i*(l_Ciy^2 + l_Ciz^2)
    I_h2xx I_h2xy I_h2xz I_h2yy I_h2yz I_h2zz ...
    I_h3xx I_h3xy I_h3xz I_h3yy I_h3yz I_h3zz ...
    I_h4xx I_h4xy I_h4xz I_h4yy I_h4yz I_h4zz ...
    I_h5xx I_h5xy I_h5xz I_h5yy I_h5yz I_h5zz ...
    I_h6xx I_h6xy I_h6xz I_h6yy I_h6yz I_h6zz ...
    m1_lC1x m1_lC1y m1_lC1z m2_lC2x m2_lC2y m2_lC2z m3_lC3x m3_lC3y m3_lC3z ... % page 262 _ eq 7.72 _ fig 7.13
    m4_lC4x m4_lC4y m4_lC4z m5_lC5x m5_lC5y m5_lC5z m6_lC6x m6_lC6y m6_lC6z...
    I_m1 I_m2 I_m3 I_m4 I_m5 I_m6 real;


load ../data/mat/Eq_l_test.mat   % TODO
csv_file_name = 'ur5e_data_elbow_sample_10.csv';  % TODO
csv_dir = '/home/hamid/projects/system_id_ur5e/data/logs/';
fullfile_log_data = fullfile(csv_dir, csv_file_name);

T = readtable(fullfile_log_data);
data = table2array(T);

time           = data(:,1);      % timestamp in s
qs             = data(:,2:7);    % actual_q, [q₁,…,q₆] in rad
qds            = data(:,8:13);   % actual_qd, [q̇₁,…,q̇₆] in rad/s
qdds           = data(:,14:19);  % target_qdd, [qdd1, qdd2, ..., qdd6] in rad/s^2
tcpPose        = data(:,20:25);  % actual_TCP_pose, [x,y,z, Rx, Ry, Rz]
tcpSpeed       = data(:,26:31);  % actual_TCP_speed, [vx, vy, vz, ωx, ωy, ωz]
qActualCurrent = data(:,32:37);  % actual_current, [I1, I2, …, I6] in mA
qOutputCurrent = data(:,38:43);  % joint_control_output, [I1, I2, …, I6] in mA
tcpForce       = data(:,44:49);  % actual_TCP_force, [Fx, Fy, Fz, Tx, Ty, Tz]
targetMoment   = data(:,50:55);  % target_moment, [T1, T2, ..., T6] in Nm
qTemperature   = data(:,56:end); % joint_temperatures [t1, t2, ..., t6] in degrees Celsius


% mass [kg]
m = [3.761, 8.058, 2.846, 1.37, 1.3, 0.365];

% center of mass [m]
m1_lC1 = [0.0, 0.02561, 0.00193];
m2_lC2 = [0.2125, 0.0, 0.11336];
m3_lC3 = [0.15, 0.0, 0.0265];
m4_lC4 = [0.0, -0.0018, 0.01634];
m5_lC5 = [0.0, 0.0018, 0.01634];
m6_lC6 = [0.0, 0.0, -0.001159];

% motor inertia
I_m = [6.6119 4.6147 7.9773 1.2249 1.1868 1.1981]*1e-5;

% link inertia [I_xx I_yy I_zz I_xy I_yz I_xz] [kgm^2]
I_h1 = [ 0.0067, 0.0064, 0.0067, 0.0, 0.0, 0.0];
I_h2 = [ 0.0149, 0.3564, 0.3553, 0.0, 0.0, 0.0];
I_h3 = [ 0.0025, 0.0551, 0.0546, 0.0, 0.0, 0.0034];
I_h4 = [ 0.0012, 0.0012, 0.0009, 0.0, 0.0, 0.0];
I_h5 = [ 0.0012, 0.0012, 0.009, 0.0, 0.0, 0.0];
I_h6 = [ 0.001, 0.001, 0.001, 0.0, 0.0, 0.0];

% tau = double(subs(Eq_l(1), [q1 q2 q3 q4 q5 q6 ...
%                             dq1 dq2 dq3 dq4 dq5 dq6 ...
%                             ddq1 ddq2 ddq3 ddq4 ddq5 ddq6 ...
%                             I_m1 I_m2 I_m3 I_m4 I_m5 I_m6 ...
%                             I_h1xx I_h1yy I_h1zz I_h1xy I_h1yz I_h1xz    ...
%                             I_h2xx I_h2yy I_h2zz I_h2xy I_h2yz I_h2xz    ...
%                             I_h3xx I_h3yy I_h3zz I_h3xy I_h3yz I_h3xz    ...
%                             I_h4xx I_h4yy I_h4zz I_h4xy I_h4yz I_h4xz    ...
%                             I_h5xx I_h5yy I_h5zz I_h5xy I_h5yz I_h5xz    ...
%                             I_h6xx I_h6yy I_h6zz I_h6xy I_h6yz I_h6xz    ...
%                             m1_lC1x m1_lC1y m1_lC1z ...
%                             m2_lC2x m2_lC2y m2_lC2z ...
%                             m3_lC3x m3_lC3y m3_lC3z ...
%                             m4_lC4x m4_lC4y m4_lC4z ...
%                             m5_lC5x m5_lC5y m5_lC5z ...
%                             m6_lC6x m6_lC6y m6_lC6z ...
%                             m1 m2 m3 m4 m5 m6], ...
%                             [1 1 1 1 1 1 ...
%                              1 1 1 1 1 1 ...
%                              1 1 1 1 1 1 ...
%                              I_m(1) I_m(2) I_m(3) I_m(4) I_m(5) I_m(6) ...
%                              I_h1(1) I_h1(2) I_h1(3) I_h1(4) I_h1(5) I_h1(6) ...
%                              I_h2(1) I_h2(2) I_h2(3) I_h2(4) I_h2(5) I_h2(6) ...
%                              I_h3(1) I_h3(2) I_h3(3) I_h3(4) I_h3(5) I_h3(6) ...
%                              I_h4(1) I_h4(2) I_h4(3) I_h4(4) I_h4(5) I_h4(6) ...
%                              I_h5(1) I_h5(2) I_h5(3) I_h5(4) I_h5(5) I_h5(6) ...
%                              I_h6(1) I_h6(2) I_h6(3) I_h6(4) I_h6(5) I_h6(6) ...
%                              m1_lC1(1) m1_lC1(2) m1_lC1(3) ...
%                              m2_lC2(1) m2_lC2(2) m2_lC2(3) ...
%                              m3_lC3(1) m3_lC3(2) m3_lC3(3) ...
%                              m4_lC4(1) m4_lC4(2) m4_lC4(3) ...
%                              m5_lC5(1) m5_lC5(2) m5_lC5(3) ...
%                              m6_lC6(1) m6_lC6(2) m6_lC6(3) ...
%                              m(1) m(2) m(3) m(4) m(5) m(6)]))

num_of_data = size(qs,1)
tau_hat     = zeros(num_of_data,6);

for i = 1:num_of_data
    % substitute all 6 torque expressions at once:
    vals = double( subs( Eq_l, ...
        [q1 q2 q3 q4 q5 q6, ...
         dq1 dq2 dq3 dq4 dq5 dq6, ...
         ddq1 ddq2 ddq3 ddq4 ddq5 ddq6], ...
        [qs(i,:),  qds(i,:),  qdds(i,:)] ) );
    tau_hat(i,:) = vals;
    disp(i);
end

save('tau_hat.mat','time','tau_hat');



